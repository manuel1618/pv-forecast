<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://umami.manuel-ramsaier.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data:; connect-src 'self' https://nominatim.openstreetmap.org https://api.open-meteo.com https://cdn.jsdelivr.net https://umami.manuel-ramsaier.com; font-src 'self' https://cdn.jsdelivr.net;">
    <title>PV Forecast Calculator</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>☀️</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
    
    <!-- Umami Analytics -->
    <script defer src="https://umami.manuel-ramsaier.com/script.js" data-website-id="46d7aee4-93c7-44ae-a413-9cee3767f9e4"></script>
</head>

<body>
    <main class="container my-5">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="card-title mb-0">PV Forecast Calculator</h1>
                    </div>
                    <div class="d-flex gap-2">
                        <button id="clear-data-btn" class="btn btn-outline-warning btn-sm" title="Clear all saved data">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button id="dark-mode-toggle" class="btn btn-outline-secondary btn-sm" title="Toggle dark mode">
                            <i class="bi bi-moon" id="dark-mode-icon"></i>
                        </button>
                    </div>
                </div>


                <!-- Form -->
                <form id="forecast-form">
                    <div class="mb-4">
                        <label for="address" class="form-label">
                            Address
                            <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Enter the location where your PV system will be installed. The more specific, the better the forecast accuracy."></i>
                        </label>
                        <div class="position-relative">
                            <input type="text" class="form-control" id="address"
                                placeholder="e.g., 1600 Amphitheatre Parkway, Mountain View, CA" required
                                autocomplete="off">
                            <div id="address-suggestions" class="dropdown-menu w-100"
                                style="display: none; position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                <!-- Suggestions will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- GPS Coordinates Display -->
                    <div id="gps-coordinates-display" class="mb-3" style="display: none;">
                        <div class="alert alert-info d-flex align-items-center">
                            <i class="bi bi-geo-alt me-2"></i>
                            <div>
                                <strong>GPS Coordinates:</strong>
                                <span id="gps-coordinates-text"></span>
                                <small class="coordinates-text d-block">Using saved location data</small>
                            </div>
                        </div>
                    </div>

                    <h5 class="mb-3">PV Systems</h5>
                    <div id="pv-systems-container">
                        <!-- PV System 1 -->
                        <div class="pv-system-group mb-4">
                            <div class="row g-3 align-items-center">
                                <div class="col-md-1"><span class="badge bg-primary rounded-pill">1</span></div>
                                <div class="col-md-3">
                                    <label class="form-label">
                                        Power (kWp)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Peak power of your PV system in kilowatts. This is usually found on your inverter or system documentation."></i>
                                    </label>
                                    <input type="number" class="form-control" name="power" placeholder="0"
                                        step="0.1" value="0" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">
                                        Inclination (&deg;)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Tilt angle of your panels. 0° = flat, 90° = vertical. Optimal is usually 30-40° for most locations."></i>
                                    </label>
                                    <input type="number" class="form-control" name="inclination" placeholder="10"
                                        min="0" max="90" value="10" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">
                                        Azimuth (&deg;)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Panel orientation: 0° = South, 90° = East, -90° = West. South-facing (0°) is optimal in the Northern Hemisphere."></i>
                                    </label>
                                    <input type="number" class="form-control" name="azimuth" placeholder="0"
                                        min="-180" max="180" value="0" required>
                                </div>
                            </div>
                        </div>

                        <!-- PV System 2 -->
                        <div class="pv-system-group mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <span class="badge bg-primary rounded-pill me-2">2</span>
                                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#system2-collapse" aria-expanded="false" aria-controls="system2-collapse">
                                    <i class="bi bi-chevron-down"></i> System 2
                                </button>
                            </div>
                            <div class="collapse" id="system2-collapse">
                                <div class="row g-3 align-items-center">
                                    <div class="col-md-1"></div>
                                <div class="col-md-3">
                                    <label class="form-label">
                                        Power (kWp)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Peak power of your PV system in kilowatts. This is usually found on your inverter or system documentation."></i>
                                    </label>
                                    <input type="number" class="form-control" name="power" placeholder="0"
                                        step="0.1" value="0" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">
                                        Inclination (&deg;)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Tilt angle of your panels. 0° = flat, 90° = vertical. Optimal is usually 30-40° for most locations."></i>
                                    </label>
                                    <input type="number" class="form-control" name="inclination" placeholder="10"
                                        min="0" max="90" value="10" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">
                                        Azimuth (&deg;)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Panel orientation: 0° = South, 90° = East, -90° = West. South-facing (0°) is optimal in the Northern Hemisphere."></i>
                                    </label>
                                    <input type="number" class="form-control" name="azimuth" placeholder="0"
                                        min="-180" max="180" value="0" required>
                                </div>
                                </div>
                            </div>
                        </div>

                        <!-- PV System 3 -->
                        <div class="pv-system-group mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <span class="badge bg-primary rounded-pill me-2">3</span>
                                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#system3-collapse" aria-expanded="false" aria-controls="system3-collapse">
                                    <i class="bi bi-chevron-down"></i> System 3
                                </button>
                            </div>
                            <div class="collapse" id="system3-collapse">
                                <div class="row g-3 align-items-center">
                                    <div class="col-md-1"></div>
                                <div class="col-md-3">
                                    <label class="form-label">
                                        Power (kWp)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Peak power of your PV system in kilowatts. This is usually found on your inverter or system documentation."></i>
                                    </label>
                                    <input type="number" class="form-control" name="power" placeholder="0"
                                        step="0.1" value="0" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">
                                        Inclination (&deg;)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Tilt angle of your panels. 0° = flat, 90° = vertical. Optimal is usually 30-40° for most locations."></i>
                                    </label>
                                    <input type="number" class="form-control" name="inclination" placeholder="10"
                                        min="0" max="90" value="10" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">
                                        Azimuth (&deg;)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Panel orientation: 0° = South, 90° = East, -90° = West. South-facing (0°) is optimal in the Northern Hemisphere."></i>
                                    </label>
                                    <input type="number" class="form-control" name="azimuth" placeholder="0"
                                        min="-180" max="180" value="0" required>
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Settings -->
                    <div class="mt-4">
                        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#advanced-settings" aria-expanded="false" aria-controls="advanced-settings">
                            <i class="bi bi-gear"></i> Advanced Settings
                        </button>
                        <div class="collapse mt-3" id="advanced-settings">
                            <div class="card card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="temperature-coefficient" class="form-label">
                                            Temperature Coefficient (%/°C)
                                            <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                               title="How much panel efficiency decreases per degree above STC temperature. Typical values: -0.3% to -0.5% per °C."></i>
                                        </label>
                                        <select class="form-select" id="temperature-coefficient">
                                            <option value="-0.002">-0.2% per °C (Low temperature sensitivity)</option>
                                            <option value="-0.003" selected>-0.3% per °C (Moderate)</option>
                                            <option value="-0.004">-0.4% per °C (Standard)</option>
                                            <option value="-0.005">-0.5% per °C (High temperature sensitivity)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="stc-temperature" class="form-label">
                                            STC Temperature (°C)
                                            <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                               title="Standard Test Conditions temperature. Most panels are rated at 25°C, but some are rated at 20°C or 30°C."></i>
                                        </label>
                                        <select class="form-select" id="stc-temperature">
                                            <option value="20">20°C (Some European panels)</option>
                                            <option value="25" selected>25°C (Standard IEC rating)</option>
                                            <option value="30">30°C (Some high-temperature panels)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">Calculate Forecast</button>
                    </div>
                    
                    <!-- Calculation Method Details -->
                    <div class="mt-4">
                        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#calculation-details" aria-expanded="false" aria-controls="calculation-details">
                            <i class="bi bi-chevron-down"></i> 📊 Calculation Method Details
                        </button>
                        <div class="collapse mt-3" id="calculation-details">
                            <div class="card card-body">
                                <p class="mb-1"><strong>Main Formula:</strong> Power = System Power × (Irradiance / 1000) × 75% × Temperature Factor</p>
                                <p class="mb-1"><strong>Temperature Factor:</strong> Temperature Factor = 1 + Temperature Coefficient × (Cell Temperature - STC Temperature)</p>
                                <p class="mb-1"><strong>Cell Temperature:</strong> Cell Temperature = Ambient Temperature + (Irradiance / 1000) × 20°C</p>
                                <p class="mb-1"><strong>Step-by-Step:</strong></p>
                                <ul class="mb-3">
                                    <li><strong>Step 1:</strong> Power Ratio = Irradiance (W/m²) ÷ 1000</li>
                                    <li><strong>Step 2:</strong> Cell Temperature = Ambient Temperature + (Irradiance ÷ 1000) × 20°C</li>
                                    <li><strong>Step 3:</strong> Temperature Factor = 1 + Temperature Coefficient × (Cell Temperature - STC Temperature)</li>
                                    <li><strong>Step 4:</strong> Hourly Power = System Power × Power Ratio × 0.75 × Temperature Factor</li>
                                </ul>
                                <p class="mb-1"><strong>Advanced Settings:</strong> Temperature coefficient and STC temperature can be configured in Advanced Settings to match your specific panel specifications.</p>
                                <p class="mb-0"><strong>Assumptions:</strong> Base 75% efficiency includes inverter, cable, and system losses. Temperature factor accounts for panel heating (configurable % per °C above STC temperature). The weather API handles panel orientation, but temperature affects performance differently for different orientations.</p>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Results -->
                <div id="results-container" class="mt-5" style="display: none;">
                    <div class="text-center">
                        <h2>Total Expected Energy</h2>
                        <p id="total-kwh" class="display-4 fw-bold">-</p>
                        <div class="mt-3">
                            <button id="export-btn" class="btn btn-outline-success btn-sm me-2">
                                <i class="bi bi-download"></i> Export CSV
                            </button>
                            <button id="share-btn" class="btn btn-outline-info btn-sm">
                                <i class="bi bi-share"></i> Share
                            </button>
                        </div>
                    </div>

                    <!-- Chart Navigation -->
                    <div class="chart-navigation mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <button id="prev-day-btn" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-chevron-left"></i> Previous Day
                            </button>
                            <div class="d-flex align-items-center gap-2">
                                <h5 id="current-date" class="mb-0">Today</h5>
                                <div class="btn-group btn-group-sm" role="group">
                                    <input type="radio" class="btn-check" name="chart-view" id="daily-view" autocomplete="off" checked>
                                    <label class="btn btn-outline-primary" for="daily-view">Daily</label>
                                    
                                    <input type="radio" class="btn-check" name="chart-view" id="weekly-view" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="weekly-view">Weekly</label>
                                </div>
                            </div>
                            <button id="next-day-btn" class="btn btn-outline-secondary btn-sm">
                                Next Day <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="forecast-chart"></canvas>
                        </div>
                        <div class="mt-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="show-temperature" checked>
                                <label class="form-check-label" for="show-temperature">
                                    Show Temperature
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div id="loading-spinner" class="text-center mt-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Calculating forecast...</p>
                </div>

                <!-- Error Message -->
                <div id="error-message" class="alert alert-danger mt-4" style="display: none;" role="alert">
                </div>

            </div>
        </div>
        
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="script.js"></script>
</body>

</html>
