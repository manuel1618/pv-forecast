<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data:; connect-src 'self' https://nominatim.openstreetmap.org https://api.open-meteo.com https://cdn.jsdelivr.net; font-src 'self' https://cdn.jsdelivr.net;">
    <title>PV Forecast Calculator</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>☀️</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <main class="container my-5">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="card-title mb-0">PV Forecast Calculator</h1>
                    </div>
                    <div class="d-flex gap-2">
                        <button id="clear-data-btn" class="btn btn-outline-warning btn-sm" title="Clear all saved data">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button id="dark-mode-toggle" class="btn btn-outline-secondary btn-sm" title="Toggle dark mode">
                            <i class="bi bi-moon" id="dark-mode-icon"></i>
                        </button>
                    </div>
                </div>

                <!-- Form -->
                <form id="forecast-form">
                    <div class="mb-4">
                        <label for="address" class="form-label">
                            Address
                            <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                               title="Enter the location where your PV system will be installed. The more specific, the better the forecast accuracy."></i>
                        </label>
                        <div class="position-relative">
                            <input type="text" class="form-control" id="address"
                                placeholder="e.g., 1600 Amphitheatre Parkway, Mountain View, CA" required
                                autocomplete="off">
                            <div id="address-suggestions" class="dropdown-menu w-100"
                                style="display: none; position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                <!-- Suggestions will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- GPS Coordinates Display -->
                    <div id="gps-coordinates-display" class="mb-3" style="display: none;">
                        <div class="alert alert-info d-flex align-items-center">
                            <i class="bi bi-geo-alt me-2"></i>
                            <div>
                                <strong>GPS Coordinates:</strong>
                                <span id="gps-coordinates-text"></span>
                                <small class="coordinates-text d-block">Using saved location data</small>
                            </div>
                        </div>
                    </div>

                    <h5 class="mb-3">PV Systems</h5>
                    <div id="pv-systems-container">
                        <!-- PV System 1 -->
                        <div class="pv-system-group mb-4">
                            <div class="row g-3 align-items-center">
                                <div class="col-md-1"><span class="badge bg-primary rounded-pill">1</span></div>
                                <div class="col-md-3">
                                    <label class="form-label">
                                        Power (kWp)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Peak power of your PV system in kilowatts. This is usually found on your inverter or system documentation."></i>
                                    </label>
                                    <input type="number" class="form-control" name="power" placeholder="0"
                                        step="0.1" value="0" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">
                                        Inclination (&deg;)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Tilt angle of your panels. 0° = flat, 90° = vertical. Optimal is usually 30-40° for most locations."></i>
                                    </label>
                                    <input type="number" class="form-control" name="inclination" placeholder="10"
                                        min="0" max="90" value="10" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">
                                        Azimuth (&deg;)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Panel orientation: 0° = South, 90° = East, -90° = West. South-facing (0°) is optimal in the Northern Hemisphere."></i>
                                    </label>
                                    <input type="number" class="form-control" name="azimuth" placeholder="0"
                                        min="-180" max="180" value="0" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">
                                        System Losses (%)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Total system losses including inverter efficiency, wiring, dust, etc. 14% is a typical default value."></i>
                                    </label>
                                    <input type="number" class="form-control" name="system_losses" placeholder="14"
                                        min="5" max="25" step="1" value="14">
                                </div>
                            </div>
                        </div>

                        <!-- PV System 2 -->
                        <div class="pv-system-group mb-4">
                            <div class="row g-3 align-items-center">
                                <div class="col-md-1"><span class="badge bg-primary rounded-pill">2</span></div>
                                <div class="col-md-3">
                                    <label class="form-label">
                                        Power (kWp)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Peak power of your PV system in kilowatts. This is usually found on your inverter or system documentation."></i>
                                    </label>
                                    <input type="number" class="form-control" name="power" placeholder="0"
                                        step="0.1" value="0" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">
                                        Inclination (&deg;)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Tilt angle of your panels. 0° = flat, 90° = vertical. Optimal is usually 30-40° for most locations."></i>
                                    </label>
                                    <input type="number" class="form-control" name="inclination" placeholder="10"
                                        min="0" max="90" value="10" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">
                                        Azimuth (&deg;)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Panel orientation: 0° = South, 90° = East, -90° = West. South-facing (0°) is optimal in the Northern Hemisphere."></i>
                                    </label>
                                    <input type="number" class="form-control" name="azimuth" placeholder="0"
                                        min="-180" max="180" value="0" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">
                                        System Losses (%)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Total system losses including inverter efficiency, wiring, dust, etc. 14% is a typical default value."></i>
                                    </label>
                                    <input type="number" class="form-control" name="system_losses" placeholder="14"
                                        min="5" max="25" step="1" value="14">
                                </div>
                            </div>
                        </div>

                        <!-- PV System 3 -->
                        <div class="pv-system-group mb-4">
                            <div class="row g-3 align-items-center">
                                <div class="col-md-1"><span class="badge bg-primary rounded-pill">3</span></div>
                                <div class="col-md-3">
                                    <label class="form-label">
                                        Power (kWp)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Peak power of your PV system in kilowatts. This is usually found on your inverter or system documentation."></i>
                                    </label>
                                    <input type="number" class="form-control" name="power" placeholder="0"
                                        step="0.1" value="0" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">
                                        Inclination (&deg;)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Tilt angle of your panels. 0° = flat, 90° = vertical. Optimal is usually 30-40° for most locations."></i>
                                    </label>
                                    <input type="number" class="form-control" name="inclination" placeholder="10"
                                        min="0" max="90" value="10" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">
                                        Azimuth (&deg;)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Panel orientation: 0° = South, 90° = East, -90° = West. South-facing (0°) is optimal in the Northern Hemisphere."></i>
                                    </label>
                                    <input type="number" class="form-control" name="azimuth" placeholder="0"
                                        min="-180" max="180" value="0" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">
                                        System Losses (%)
                                        <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Total system losses including inverter efficiency, wiring, dust, etc. 14% is a typical default value."></i>
                                    </label>
                                    <input type="number" class="form-control" name="system_losses" placeholder="14"
                                        min="5" max="25" step="1" value="14">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">Calculate Forecast</button>
                    </div>
                </form>

                <!-- Results -->
                <div id="results-container" class="mt-5" style="display: none;">
                    <div class="text-center">
                        <h2>Total Expected Energy</h2>
                        <p id="total-kwh" class="display-4 fw-bold">-</p>
                        <div class="mt-3">
                            <button id="export-btn" class="btn btn-outline-success btn-sm me-2">
                                <i class="bi bi-download"></i> Export CSV
                            </button>
                            <button id="share-btn" class="btn btn-outline-info btn-sm">
                                <i class="bi bi-share"></i> Share
                            </button>
                        </div>
                    </div>

                    <!-- Chart Navigation -->
                    <div class="chart-navigation mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <button id="prev-day-btn" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-chevron-left"></i> Previous Day
                            </button>
                            <div class="d-flex align-items-center gap-2">
                                <h5 id="current-date" class="mb-0">Today</h5>
                                <div class="btn-group btn-group-sm" role="group">
                                    <input type="radio" class="btn-check" name="chart-view" id="daily-view" autocomplete="off" checked>
                                    <label class="btn btn-outline-primary" for="daily-view">Daily</label>
                                    
                                    <input type="radio" class="btn-check" name="chart-view" id="weekly-view" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="weekly-view">Weekly</label>
                                </div>
                            </div>
                            <button id="next-day-btn" class="btn btn-outline-secondary btn-sm">
                                Next Day <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="forecast-chart"></canvas>
                        </div>
                        <div class="mt-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="show-temperature" checked>
                                <label class="form-check-label" for="show-temperature">
                                    Show Temperature
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div id="loading-spinner" class="text-center mt-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Calculating forecast...</p>
                </div>

                <!-- Error Message -->
                <div id="error-message" class="alert alert-danger mt-4" style="display: none;" role="alert">
                </div>

            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="script.js"></script>
</body>

</html>
